<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Nulls Brawl</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-6">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-4xl font-bold text-center mb-8 bg-clip-text text-transparent bg-gradient-to-r from-yellow-400 to-red-500">
      üéÆ Admin Panel
    </h1>

    <div class="bg-gray-800 rounded-xl p-6 mb-6 border border-indigo-700">
      <h2 class="text-xl font-semibold text-indigo-300 mb-3">üîê Authentification administrateur</h2>
      <div class="flex flex-col md:flex-row gap-3 items-stretch md:items-center">
        <input
          id="adminTokenInput"
          type="password"
          placeholder="Token administrateur"
          class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg focus:border-indigo-500 focus:outline-none"
        />
        <button
          onclick="saveAdminToken()"
          class="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-bold transition"
        >
          Enregistrer
        </button>
        <button
          onclick="clearAdminToken()"
          class="px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-semibold transition"
        >
          Effacer
        </button>
      </div>
      <p id="tokenStatus" class="mt-3 text-sm text-gray-300"></p>
    </div>

    <!-- LISTE DES UTILISATEURS -->
    <div class="bg-gray-800 rounded-xl p-6 mb-6 border border-cyan-500/60">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
        <h2 class="text-2xl font-bold text-cyan-300">üë• Comptes utilisateurs inscrits</h2>
        <button
          onclick="loadUsers()"
          class="self-start md:self-auto px-4 py-2 bg-cyan-600 hover:bg-cyan-500 rounded-lg font-bold transition"
        >
          üîÑ Actualiser
        </button>
      </div>
      <div id="usersList" class="space-y-3 max-h-96 overflow-y-auto pr-1">
        <p class="text-gray-400">Chargement...</p>
      </div>
    </div>

    <!-- LIER UN COMPTE UTILISATEUR √Ä UN JOUEUR -->
    <div id="linkSection" class="bg-gray-800 rounded-xl p-6 mb-6 border border-purple-400">
      <h2 class="text-2xl font-bold mb-4 text-purple-300">üîó Lier un compte utilisateur √† un joueur</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label for="linkUserEmail" class="block text-sm font-semibold text-gray-300 mb-2">Email du compte Supabase</label>
          <input
            id="linkUserEmail"
            type="email"
            placeholder="email@exemple.com"
            class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none"
          />
        </div>
        <div>
          <label for="linkPlayerName" class="block text-sm font-semibold text-gray-300 mb-2">Pseudo du joueur</label>
          <input
            id="linkPlayerName"
            type="text"
            placeholder="Pseudo existant dans le classement"
            class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg focus:border-purple-500 focus:outline-none"
          />
        </div>
      </div>
      <button
        onclick="linkUserToPlayer()"
        class="mt-4 w-full py-3 bg-purple-600 hover:bg-purple-500 rounded-lg font-bold transition"
      >
        üîó Lier le compte au joueur
      </button>
      <div id="linkUserResult" class="mt-3 text-sm"></div>
    </div>

    <!-- AJOUTER UN JOUEUR -->
    <div class="bg-gray-800 rounded-xl p-6 mb-6 border border-gray-700">
      <h2 class="text-2xl font-bold mb-4 text-indigo-400">‚ûï Ajouter un joueur</h2>
      <div class="flex gap-3">
        <input 
          id="newPlayerName" 
          type="text" 
          placeholder="Pseudo du joueur..." 
          class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg focus:border-indigo-500 focus:outline-none"
        />
        <button 
          onclick="addPlayer()" 
          class="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-bold transition"
        >
          Ajouter (1000 MMR)
        </button>
      </div>
      <div id="addPlayerResult" class="mt-3 text-sm"></div>
    </div>

    <!-- REPORTER UN MATCH 3v3 -->
    <div class="bg-gray-800 rounded-xl p-6 mb-6 border border-gray-700">
      <h2 class="text-2xl font-bold mb-4 text-green-400">‚öîÔ∏è Reporter un match 3v3</h2>
      
      <div class="grid md:grid-cols-2 gap-6 mb-4">
        <!-- Team A -->
        <div class="bg-gray-900 p-4 rounded-lg border border-green-500">
          <h3 class="font-bold text-green-400 mb-3">üü¢ Team A (Gagnants)</h3>
          <input id="teamA1" type="text" placeholder="Joueur 1" class="w-full mb-2 px-3 py-2 bg-gray-800 border border-gray-700 rounded focus:border-green-500 focus:outline-none" />
          <input id="teamA2" type="text" placeholder="Joueur 2" class="w-full mb-2 px-3 py-2 bg-gray-800 border border-gray-700 rounded focus:border-green-500 focus:outline-none" />
          <input id="teamA3" type="text" placeholder="Joueur 3" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded focus:border-green-500 focus:outline-none" />
          <input id="scoreA" type="number" value="2" min="0" class="w-full mt-3 px-3 py-2 bg-gray-800 border border-gray-700 rounded focus:border-green-500 focus:outline-none font-bold text-2xl text-center" />
        </div>

        <!-- Team B -->
        <div class="bg-gray-900 p-4 rounded-lg border border-red-500">
          <h3 class="font-bold text-red-400 mb-3">üî¥ Team B (Perdants)</h3>
          <input id="teamB1" type="text" placeholder="Joueur 1" class="w-full mb-2 px-3 py-2 bg-gray-800 border border-gray-700 rounded focus:border-red-500 focus:outline-none" />
          <input id="teamB2" type="text" placeholder="Joueur 2" class="w-full mb-2 px-3 py-2 bg-gray-800 border border-gray-700 rounded focus:border-red-500 focus:outline-none" />
          <input id="teamB3" type="text" placeholder="Joueur 3" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded focus:border-red-500 focus:outline-none" />
          <input id="scoreB" type="number" value="1" min="0" class="w-full mt-3 px-3 py-2 bg-gray-800 border border-gray-700 rounded focus:border-red-500 focus:outline-none font-bold text-2xl text-center" />
        </div>
      </div>

      <button 
        onclick="reportMatch()" 
        class="w-full py-4 bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-500 hover:to-blue-500 rounded-lg font-bold text-xl transition"
      >
        üéØ Valider le match
      </button>
      <div id="matchResult" class="mt-3 text-sm"></div>
    </div>

    <!-- LISTE DES JOUEURS -->
    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold text-purple-400">üìã Liste des joueurs</h2>
        <button 
          onclick="loadPlayers()" 
          class="px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg font-bold transition"
        >
          üîÑ Actualiser
        </button>
      </div>
      <div id="playersList" class="space-y-2 max-h-96 overflow-y-auto">
        <p class="text-gray-400">Chargement...</p>
      </div>
    </div>
  </div>

  <script>
    const isLocalhost = ['localhost', '127.0.0.1'].includes(window.location.hostname);
    const API_BASE = isLocalhost
      ? 'http://localhost:8888/.netlify/functions'
      : '/api';

    let adminToken = '';
    let playersCache = [];
    let usersCache = [];

    function escapeHtml(str = '') {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function initAdminToken() {
      adminToken = localStorage.getItem('adminToken') || '';
      document.getElementById('adminTokenInput').value = adminToken;
      updateTokenStatus(adminToken ? 'Token charg√© depuis le navigateur.' : 'Renseigne ton token pour acc√©der aux actions.');
      if (adminToken) {
        loadPlayers();
        loadUsers();
      } else {
        document.getElementById('playersList').innerHTML = '<p class="text-yellow-400">üîí Token requis pour charger les joueurs.</p>';
        document.getElementById('usersList').innerHTML = '<p class="text-yellow-400">üîí Token requis pour charger les utilisateurs.</p>';
      }
    }

    function saveAdminToken() {
      adminToken = document.getElementById('adminTokenInput').value.trim();
      if (adminToken) {
        localStorage.setItem('adminToken', adminToken);
        updateTokenStatus('Token enregistr√© localement.', 'success');
        loadPlayers();
        loadUsers();
      } else {
        localStorage.removeItem('adminToken');
        updateTokenStatus('Token vide. Merci de renseigner une valeur.', 'warning');
        document.getElementById('playersList').innerHTML = '<p class="text-yellow-400">üîí Token requis pour charger les joueurs.</p>';
        document.getElementById('usersList').innerHTML = '<p class="text-yellow-400">üîí Token requis pour charger les utilisateurs.</p>';
      }
    }

    function clearAdminToken() {
      adminToken = '';
      localStorage.removeItem('adminToken');
      document.getElementById('adminTokenInput').value = '';
      updateTokenStatus('Token supprim√© du navigateur.', 'warning');
      document.getElementById('playersList').innerHTML = '<p class="text-yellow-400">üîí Token requis pour charger les joueurs.</p>';
      document.getElementById('usersList').innerHTML = '<p class="text-yellow-400">üîí Token requis pour charger les utilisateurs.</p>';
    }

    function updateTokenStatus(message, tone = 'info') {
      const status = document.getElementById('tokenStatus');
      const colors = {
        info: 'text-gray-300',
        warning: 'text-yellow-400',
        success: 'text-green-400',
        error: 'text-red-400'
      };
      status.className = `mt-3 text-sm ${colors[tone] || colors.info}`;
      status.textContent = message;
    }

    async function adminFetch(path, options = {}) {
      if (!adminToken) {
        throw new Error('Token administrateur requis.');
      }

      const headers = {
        ...(options.headers || {}),
        'X-Admin-Token': adminToken
      };

      const response = await fetch(path, { ...options, headers });
      if (response.status === 401) {
        updateTokenStatus('Acc√®s refus√©. V√©rifie le token administrateur.', 'error');
        throw new Error('Acc√®s administrateur refus√©.');
      }
      if (response.status === 500) {
        updateTokenStatus('La configuration serveur est incompl√®te.', 'error');
      }
      return response;
    }

    window.onload = () => {
      initAdminToken();
    };

    // Fonction pour charger les utilisateurs Supabase
    async function loadUsers() {
      const listDiv = document.getElementById('usersList');

      if (!adminToken) {
        listDiv.innerHTML = '<p class="text-yellow-400">üîí Token requis pour charger les utilisateurs.</p>';
        return;
      }

      listDiv.innerHTML = '<p class="text-gray-300">‚è≥ Chargement des utilisateurs...</p>';

      try {
        const res = await adminFetch(`${API_BASE}/listAllUsers`);
        const data = await res.json();

        if (data.ok) {
          usersCache = data.users || [];
          displayUsers(usersCache);
          updateTokenStatus('Donn√©es charg√©es avec succ√®s.', 'success');
        } else {
          listDiv.innerHTML = `<p class="text-red-400">‚ùå ${data.error || 'Impossible de charger les utilisateurs.'}</p>`;
        }
      } catch (err) {
        listDiv.innerHTML = `<p class="text-red-400">‚ùå Erreur: ${err.message}</p>`;
      }
    }

    function displayUsers(users) {
      const container = document.getElementById('usersList');

      if (!users || users.length === 0) {
        container.innerHTML = '<p class="text-gray-400">Aucun utilisateur inscrit pour le moment.</p>';
        return;
      }

      container.innerHTML = users.map((user) => {
        const confirmed = Boolean(user.email_confirmed_at);
        const statusIcon = confirmed ? '‚úÖ' : '‚è≥';
        const statusColor = confirmed ? 'text-green-400' : 'text-yellow-400';
        const linkedPlayer = playersCache.find((p) => p.user_id === user.id);
        const linkedPlayerName = linkedPlayer ? escapeHtml(linkedPlayer.display_name || '') : '';
        const linkInfo = linkedPlayer
          ? `<span class="text-green-400 font-medium">üîó Li√© √† ${linkedPlayerName}</span>`
          : '<span class="text-gray-400">Non li√©</span>';
        const createdAt = user.created_at ? new Date(user.created_at).toLocaleString('fr-FR') : 'Inconnu';
        const lastSignIn = user.last_sign_in_at ? new Date(user.last_sign_in_at).toLocaleString('fr-FR') : 'Jamais';
        const rawEmail = user.email || '';
        const safeEmail = escapeHtml(rawEmail);
        const encodedEmail = encodeURIComponent(rawEmail);

        const metadataDisplayName = user?.user_metadata?.display_name;
        let rawMetadataDisplayName = '';
        if (user?.raw_user_meta_data) {
          if (typeof user.raw_user_meta_data === 'string') {
            try {
              const parsedMeta = JSON.parse(user.raw_user_meta_data);
              rawMetadataDisplayName = parsedMeta?.display_name || '';
            } catch (e) {
              rawMetadataDisplayName = '';
            }
          } else if (typeof user.raw_user_meta_data === 'object') {
            rawMetadataDisplayName = user.raw_user_meta_data?.display_name || '';
          }
        }

        const displayName = metadataDisplayName || rawMetadataDisplayName || '';
        const hasDisplayName = Boolean(displayName && displayName.trim());
        const safeDisplayName = hasDisplayName ? escapeHtml(displayName) : '';
        const pseudoClasses = hasDisplayName
          ? 'text-xl font-bold text-gray-100 flex items-center gap-2'
          : 'text-xl font-bold text-gray-400 italic flex items-center gap-2';
        const pseudoLabel = hasDisplayName ? safeDisplayName : 'Pas de pseudo renseign√©';
        const emailLabel = safeEmail || 'Email inconnu';

        return `
          <div class="bg-gray-900 border border-cyan-500/40 hover:border-cyan-400 transition rounded-lg p-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
              <div class="flex-1">
                <p class="${pseudoClasses}"><span>üéÆ</span><span>${pseudoLabel}</span></p>
                <p class="text-sm text-gray-300 break-all">${emailLabel}</p>
                <p class="text-xs text-gray-400 mt-1">Inscription: ${createdAt}</p>
                <p class="text-xs text-gray-500">Derni√®re connexion: ${lastSignIn}</p>
              </div>
              <div class="flex items-center gap-3">
                <span class="${statusColor} text-xl">${statusIcon}</span>
                <div class="text-sm">${linkInfo}</div>
                <button
                  class="px-3 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg font-semibold transition"
                  data-email="${encodedEmail}"
                  onclick="autofillLinkForm(this.dataset.email)"
                >
                  Lier ‚Üí
                </button>
              </div>
            </div>
            <p class="text-xs text-gray-500 mt-2">ID: ${user.id}</p>
          </div>
        `;
      }).join('');
    }

    function autofillLinkForm(email) {
      const decodedEmail = email ? decodeURIComponent(email) : '';
      const emailInput = document.getElementById('linkUserEmail');
      emailInput.value = decodedEmail;
      emailInput.focus();
      const section = document.getElementById('linkSection');
      if (section) {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    // Fonction pour charger tous les joueurs (pas juste top 50)
    async function loadPlayers() {
      try {
        if (!adminToken) {
          updateTokenStatus('Token requis pour charger les joueurs.', 'warning');
          return;
        }

        const res = await adminFetch(`${API_BASE}/getAllPlayers`);
        const data = await res.json();

        if (data.ok) {
          playersCache = data.players;
          displayPlayers(playersCache);
          if (usersCache.length) {
            displayUsers(usersCache);
          }
          updateTokenStatus('Donn√©es charg√©es avec succ√®s.', 'success');
        } else {
          document.getElementById('playersList').innerHTML = `<p class="text-red-400">‚ùå ${data.error}</p>`;
        }
      } catch (err) {
        if (err.message.includes('Token administrateur')) {
          document.getElementById('playersList').innerHTML = '<p class="text-yellow-400">üîí Token requis pour charger les joueurs.</p>';
        } else {
          document.getElementById('playersList').innerHTML = `<p class="text-red-400">‚ùå Erreur: ${err.message}</p>`;
        }
      }
    }

    // Afficher la liste des joueurs
    function displayPlayers(players) {
      const html = players.map((p, i) => `
        <div class="bg-gray-900 p-3 rounded-lg flex items-center justify-between border border-gray-700 hover:border-indigo-500 transition">
          <div>
            <span class="font-bold text-lg">#${i+1} ${p.display_name}</span>
            <span class="text-gray-400 text-sm ml-2">(${p.mmr} MMR)</span>
          </div>
          <div class="text-xs text-gray-500">
            ID: ${p.id.slice(0,8)}...
          </div>
        </div>
      `).join('');
      document.getElementById('playersList').innerHTML = html || '<p class="text-gray-400">Aucun joueur</p>';
    }

    // Ajouter un joueur
    async function addPlayer() {
      const name = document.getElementById('newPlayerName').value.trim();
      const resultDiv = document.getElementById('addPlayerResult');
      
      if (!name) {
        resultDiv.innerHTML = '<p class="text-red-400">‚ùå Entre un pseudo !</p>';
        return;
      }

      if (name.length < 3 || name.length > 24) {
        resultDiv.innerHTML = '<p class="text-red-400">‚ùå Le pseudo doit contenir entre 3 et 24 caract√®res.</p>';
        return;
      }

      // V√©rifier si le joueur existe d√©j√†
      const existing = playersCache.find(p => p.display_name.toLowerCase() === name.toLowerCase());
      if (existing) {
        resultDiv.innerHTML = `<p class="text-red-400">‚ùå ${name} existe d√©j√† dans la base !</p>`;
        return;
      }

      resultDiv.innerHTML = '<p class="text-yellow-400">‚è≥ Ajout en cours...</p>';

      try {
        const res = await adminFetch(`${API_BASE}/registerUser`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ display_name: name })
        });
        const data = await res.json();

        if (data.ok) {
          resultDiv.innerHTML = `<p class="text-green-400">‚úÖ ${name} ajout√© avec 1000 MMR ! Rechargement...</p>`;
          document.getElementById('newPlayerName').value = '';
          // Recharger imm√©diatement pour mettre √† jour le cache
          await loadPlayers();
          resultDiv.innerHTML = `<p class="text-green-400">‚úÖ ${name} est maintenant disponible pour les matchs !</p>`;
          setTimeout(() => { resultDiv.innerHTML = ''; }, 3000);
        } else {
          resultDiv.innerHTML = `<p class="text-red-400">‚ùå ${data.error}</p>`;
        }
      } catch (err) {
        resultDiv.innerHTML = `<p class="text-red-400">‚ùå Erreur: ${err.message}</p>`;
      }
    }

    // Trouver l'ID d'un joueur par son pseudo (insensible √† la casse et espaces)
    function findPlayerByName(name) {
      const normalized = name.trim().toLowerCase().replace(/\s+/g, '');
      return playersCache.find(p => {
        const playerName = p.display_name.toLowerCase().replace(/\s+/g, '');
        return playerName === normalized || playerName.includes(normalized) || normalized.includes(playerName);
      });
    }

    // Reporter un match
    async function reportMatch() {
      const resultDiv = document.getElementById('matchResult');
      
      // R√©cup√©rer les pseudos
      const teamANames = [
        document.getElementById('teamA1').value.trim(),
        document.getElementById('teamA2').value.trim(),
        document.getElementById('teamA3').value.trim()
      ].filter(n => n !== '');

      const teamBNames = [
        document.getElementById('teamB1').value.trim(),
        document.getElementById('teamB2').value.trim(),
        document.getElementById('teamB3').value.trim()
      ].filter(n => n !== '');

      const scoreA = parseInt(document.getElementById('scoreA').value);
      const scoreB = parseInt(document.getElementById('scoreB').value);

      // V√©rifications
      if (teamANames.length === 0 || teamBNames.length === 0) {
        resultDiv.innerHTML = '<p class="text-red-400">‚ùå Remplis au moins 1 joueur par √©quipe !</p>';
        return;
      }

      if (scoreA === scoreB) {
        resultDiv.innerHTML = '<p class="text-red-400">‚ùå Pas de match nul autoris√© !</p>';
        return;
      }

      resultDiv.innerHTML = '<p class="text-yellow-400">‚è≥ Recherche des joueurs...</p>';

      // Convertir pseudos en IDs
      const teamA = [];
      const teamB = [];

      for (const name of teamANames) {
        const player = findPlayerByName(name);
        if (!player) {
          resultDiv.innerHTML = `<p class="text-red-400">‚ùå Joueur "${name}" introuvable (Team A)</p>`;
          return;
        }
        teamA.push(player.id);
      }

      for (const name of teamBNames) {
        const player = findPlayerByName(name);
        if (!player) {
          resultDiv.innerHTML = `<p class="text-red-400">‚ùå Joueur "${name}" introuvable (Team B)</p>`;
          return;
        }
        teamB.push(player.id);
      }

      resultDiv.innerHTML = '<p class="text-yellow-400">‚è≥ Calcul du match...</p>';

      try {
        if (!adminToken) {
          throw new Error('Token administrateur requis.');
        }

        const res = await adminFetch(`${API_BASE}/reportMatch`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ teamA, teamB, scoreA, scoreB })
        });
        const data = await res.json();

        if (data.ok) {
          // Afficher les changements de MMR
          let changesHTML = '<div class="bg-gray-900 p-4 rounded-lg mt-3"><p class="text-green-400 font-bold mb-2">‚úÖ Match enregistr√© !</p>';
          data.updates.forEach(u => {
            const player = playersCache.find(p => p.id === u.id);
            const oldMMR = player ? player.mmr : 1000;
            const delta = u.mmr - oldMMR;
            const color = delta > 0 ? 'text-green-400' : 'text-red-400';
            changesHTML += `<p class="${color}">${player?.display_name || 'Joueur'}: ${oldMMR} ‚Üí ${u.mmr} (${delta > 0 ? '+' : ''}${delta})</p>`;
          });
          changesHTML += '</div>';
          resultDiv.innerHTML = changesHTML;

          // Clear les champs
          ['teamA1','teamA2','teamA3','teamB1','teamB2','teamB3'].forEach(id => {
            document.getElementById(id).value = '';
          });

          setTimeout(() => loadPlayers(), 2000);
        } else {
          resultDiv.innerHTML = `<p class="text-red-400">‚ùå ${data.error}</p>`;
        }
      } catch (err) {
        if (err.message.includes('Token administrateur')) {
          resultDiv.innerHTML = '<p class="text-yellow-400">üîí Token requis pour enregistrer un match.</p>';
        } else {
          resultDiv.innerHTML = `<p class="text-red-400">‚ùå Erreur: ${err.message}</p>`;
        }
      }
    }

    async function linkUserToPlayer() {
      const emailInput = document.getElementById('linkUserEmail');
      const playerNameInput = document.getElementById('linkPlayerName');
      const resultDiv = document.getElementById('linkUserResult');

      const email = emailInput.value.trim();
      const playerName = playerNameInput.value.trim();

      if (!email || !playerName) {
        resultDiv.innerHTML = '<p class="text-red-400">‚ùå Merci de renseigner l\'email et le pseudo.</p>';
        return;
      }

      if (!adminToken) {
        updateTokenStatus('Token requis pour lier un joueur.', 'warning');
        resultDiv.innerHTML = '<p class="text-yellow-400">üîí Token administrateur requis.</p>';
        return;
      }

      const player = findPlayerByName(playerName);
      if (!player) {
        resultDiv.innerHTML = `<p class="text-red-400">‚ùå Joueur "${playerName}" introuvable.</p>`;
        return;
      }

      resultDiv.innerHTML = '<p class="text-yellow-400">‚è≥ Recherche du compte Supabase...</p>';

      try {
        const userRes = await adminFetch(`${API_BASE}/getUserByEmail`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const userData = await userRes.json();

        if (!userData.ok || !userData.user) {
          const message = userData.error || 'Utilisateur Supabase introuvable.';
          resultDiv.innerHTML = `<p class="text-red-400">‚ùå ${message}</p>`;
          return;
        }

        resultDiv.innerHTML = '<p class="text-yellow-400">‚è≥ Liaison en cours...</p>';

        const linkRes = await adminFetch(`${API_BASE}/linkUserToPlayer`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            player_id: player.id,
            user_id: userData.user.id
          })
        });
        const linkData = await linkRes.json();

        if (!linkData.ok || !linkData.player) {
          const message = linkData.error || 'Erreur lors de la liaison du joueur.';
          resultDiv.innerHTML = `<p class="text-red-400">‚ùå ${message}</p>`;
          return;
        }

        playersCache = playersCache.map((p) =>
          p.id === linkData.player.id ? { ...p, user_id: linkData.player.user_id } : p
        );

        resultDiv.innerHTML = `<p class="text-green-400">‚úÖ ${linkData.player.display_name} est maintenant li√© √† ${userData.user.email}.</p>`;
        if (usersCache.length) {
          displayUsers(usersCache);
        }
      } catch (err) {
        resultDiv.innerHTML = `<p class="text-red-400">‚ùå Erreur: ${err.message}</p>`;
      }
    }

    // Entrer = valider
    document.getElementById('newPlayerName').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') addPlayer();
    });
  </script>
</body>
</html>
