<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nulls Brawl Esport - Top 50 Ranking</title>
  <meta name="description" content="Classement officiel Null's Brawl Esport. D√©couvrez le Top 50 des meilleurs joueurs avec leur MMR et Tier.">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .glass-effect {
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useMemo, useCallback } = React;

const isLocalhost = ['localhost', '127.0.0.1'].includes(window.location.hostname);
const API_BASE = isLocalhost
  ? 'http://localhost:8888/.netlify/functions'
  : '/api';

const tierStyles = {
  S: 'bg-gradient-to-r from-yellow-400 via-yellow-300 to-yellow-200',
  A: 'bg-gradient-to-r from-blue-400 via-purple-300 to-indigo-200',
  B: 'bg-gradient-to-r from-orange-600 via-orange-400 to-orange-200',
  C: 'bg-gradient-to-r from-pink-600 via-red-500 to-red-400',
  D: 'bg-gradient-to-r from-blue-400 via-purple-400 to-purple-300',
  E: 'bg-gradient-to-r from-green-700 via-green-500 to-green-300',
  'No-tier': 'bg-gradient-to-r from-gray-600 via-gray-500 to-gray-400',
};

const DEFAULT_AVATAR = 'https://api.dicebear.com/7.x/bottts/svg?seed=NullsEsport&backgroundColor=1f2937,111827&radius=50';

const getMedal = (rank) => {
  if (rank === 1) return 'ü•á';
  if (rank === 2) return 'ü•à';
  if (rank === 3) return 'ü•â';
  return `#${rank}`;
};

const parseJsonField = (value, fallback) => {
  if (!value) return fallback;
  if (typeof value === 'object') return value;
  try {
    const parsed = JSON.parse(value);
    if (parsed && typeof parsed === 'object') return parsed;
    return fallback;
  } catch (err) {
    return fallback;
  }
};

const parseScrims = (value) => {
  if (!value) return [];
  let raw = value;
  if (typeof raw === 'string') {
    try {
      raw = JSON.parse(raw);
    } catch (err) {
      raw = raw.split('\n');
    }
  }
  if (!Array.isArray(raw)) return [];
  return raw
    .map(item => (typeof item === 'string' ? item.trim() : ''))
    .filter(item => item.length > 0);
};

const parsePlayersList = (value) => {
  if (!value) return [];
  if (Array.isArray(value)) {
    return value.map(item => (typeof item === 'string' ? item.trim() : '')).filter(Boolean);
  }
  if (typeof value === 'string') {
    try {
      const parsed = JSON.parse(value);
      if (Array.isArray(parsed)) {
        return parsed.map(item => (typeof item === 'string' ? item.trim() : '')).filter(Boolean);
      }
    } catch (err) {
      return value
        .split('\n')
        .map(item => item.trim())
        .filter(Boolean);
    }
  }
  return [];
};

const FREESCAPE_EVENT = Object.freeze({
  slug: 'freescape-priscup-2025',
  name: 'Freescape Cup ¬∑ S√©rie Priscup',
  description:
    "La Freescape Cup reprend l'esprit de Matcherino avec une page d√©di√©e, un suivi automatique du bracket et une gestion compl√®te des inscriptions Null's Brawl Esport.",
  date: 'Samedi 15 mars 2025 ¬∑ 20h00 CET',
  format: '3v3 ¬∑ Double √©limination rapide',
  slots: '16 √©quipes ¬∑ 3 titulaires + 1 rempla√ßant',
  prize: 'Cashprize communautaire + R√¥le Freescape exclusif',
  checkin: 'Check-in obligatoire 30 minutes avant le lancement',
  matcherinoLink: 'https://matcherino.com/',
  rules: [
    'Chaque joueur doit disposer d‚Äôun compte Null\'s Brawl Esport valid√©.',
    'Les √©quipes sont limit√©es √† 3 titulaires et 1 rempla√ßant.',
    'Le capitaine doit √™tre pr√©sent sur le Discord pour les annonces officielles.',
  ],
  maps: [
    { mode: 'Brawl Ball', name: 'Pinball Dreams' },
    { mode: 'Gem Grab', name: 'Cristal Arc-en-ciel' },
    { mode: 'Knockout', name: 'Belle Prairie' },
    { mode: 'Bounty', name: 'Soleil Noir' },
  ],
});

const FREESCAPE_FORM_DEFAULT = Object.freeze({
  teamName: '',
  captain: '',
  playerTwo: '',
  playerThree: '',
  substitute: '',
  discord: '',
  matcherino: '',
  notes: '',
  mapPreference: '',
});

const formatPlayer = (player, index) => {
  if (!player) return null;
  const recentScrims = parseScrims(player.recent_scrims);
  const socialLinks = parseJsonField(player.social_links, {});

  return {
    ...player,
    rank: player.rank || (typeof index === 'number' ? index + 1 : null),
    name: player.display_name,
    score: player.mmr,
    tier: player.tier || 'No-tier',
    gamesPlayed: player.games_played,
    profileImage: player.profile_image_url || null,
    bio: player.bio || '',
    recentScrims,
    socialLinks,
  };
};

const PlayerCard = ({ player, onSelect }) => {
  const tierClass = tierStyles[player.tier] || tierStyles['No-tier'];
  const winRate = player.gamesPlayed > 0 ? Math.round((player.wins / player.gamesPlayed) * 100) : 0;
  const avatar = player.profileImage || DEFAULT_AVATAR;

  return (
    <div
      className={`${tierClass} p-3 sm:p-5 rounded-xl shadow-2xl text-gray-900 font-bold hover:scale-105 transition-transform cursor-pointer`}
      onClick={() => onSelect(player)}
    >
      <div className="flex items-center justify-between flex-wrap gap-2">
        <div className="flex items-center gap-2 sm:gap-4">
          <span className="text-xl sm:text-3xl font-bold min-w-[50px] sm:min-w-[70px]">{getMedal(player.rank)}</span>
          <img
            src={avatar}
            alt={`Avatar de ${player.name}`}
            className="w-10 h-10 sm:w-14 sm:h-14 rounded-full border-2 border-white/50 object-cover"
            onError={(e) => {
              e.target.onerror = null;
              e.target.src = DEFAULT_AVATAR;
            }}
          />
          <div>
            <span className="text-lg sm:text-2xl block">{player.name}</span>
            <span className="text-xs sm:text-sm opacity-75">
              {player.gamesPlayed} matchs ‚Ä¢ {winRate}% WR
            </span>
          </div>
        </div>
        <div className="flex items-center gap-2 sm:gap-4">
          <span className="text-base sm:text-xl">{player.score} pts</span>
          <span className="px-3 sm:px-4 py-1.5 sm:py-2 bg-white bg-opacity-40 rounded-full text-xs sm:text-base whitespace-nowrap">
            Tier {player.tier}
          </span>
        </div>
      </div>
    </div>
  );
};

const PlayerModal = ({ player, onClose, onEdit, isOwner }) => {
  if (!player) return null;
  const avatar = player.profileImage || DEFAULT_AVATAR;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 px-3">
      <div className="bg-gray-900 text-gray-100 rounded-2xl shadow-2xl max-w-2xl w-full p-6 relative border border-gray-700 overflow-hidden">
        <button
          className="absolute top-3 right-3 text-gray-400 hover:text-gray-200"
          onClick={onClose}
          aria-label="Fermer"
        >
          ‚úï
        </button>
        <div className="flex flex-col sm:flex-row gap-6">
          <img
            src={avatar}
            alt={`Avatar de ${player.name}`}
            className="w-32 h-32 rounded-2xl object-cover border-2 border-indigo-500 shadow-lg"
            onError={(e) => {
              e.target.onerror = null;
              e.target.src = DEFAULT_AVATAR;
            }}
          />
          <div className="flex-1 space-y-4">
            <div>
              <h2 className="text-2xl font-bold flex items-center gap-2">
                {player.name}
                <span className="px-3 py-1 rounded-full bg-indigo-600 text-xs">Tier {player.tier}</span>
              </h2>
              <p className="text-sm text-gray-400">MMR: {player.score} ‚Ä¢ #{player.rank}</p>
            </div>

            {player.bio && (
              <div className="bg-gray-800/60 p-4 rounded-xl">
                <h3 className="text-lg font-semibold text-indigo-300 mb-2">Bio</h3>
                <p className="text-sm text-gray-300 whitespace-pre-line">{player.bio}</p>
              </div>
            )}

            {player.recentScrims.length > 0 && (
              <div className="bg-gray-800/60 p-4 rounded-xl">
                <h3 className="text-lg font-semibold text-yellow-300 mb-2">Scrims r√©cents</h3>
                <ul className="space-y-2 text-sm text-gray-200 list-disc list-inside">
                  {player.recentScrims.map((scrim, index) => (
                    <li key={index}>{scrim}</li>
                  ))}
                </ul>
              </div>
            )}

            {player.socialLinks && Object.keys(player.socialLinks).length > 0 && (
              <div className="bg-gray-800/60 p-4 rounded-xl">
                <h3 className="text-lg font-semibold text-green-300 mb-2">R√©seaux</h3>
                <div className="flex flex-wrap gap-2">
                  {player.socialLinks.discord && (
                    <a
                      href={player.socialLinks.discord}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="px-3 py-1 bg-indigo-600 rounded-full text-sm hover:bg-indigo-500"
                    >
                      Discord
                    </a>
                  )}
                  {player.socialLinks.twitter && (
                    <a
                      href={player.socialLinks.twitter}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="px-3 py-1 bg-sky-500 rounded-full text-sm hover:bg-sky-400"
                    >
                      X / Twitter
                    </a>
                  )}
                  {player.socialLinks.twitch && (
                    <a
                      href={player.socialLinks.twitch}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="px-3 py-1 bg-purple-600 rounded-full text-sm hover:bg-purple-500"
                    >
                      Twitch
                    </a>
                  )}
                </div>
              </div>
            )}
          </div>
        </div>

        {isOwner && (
          <div className="mt-4 flex justify-end">
            <button
              onClick={onEdit}
              className="px-4 py-2 bg-indigo-600 rounded-lg hover:bg-indigo-500 transition"
            >
              ‚úèÔ∏è Modifier ma carte
            </button>
          </div>
        )}
      </div>
    </div>
  );
};

const AuthModal = ({ mode, onClose, onSubmit, switchMode, loading, error, message }) => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [displayName, setDisplayName] = useState('');

  useEffect(() => {
    setEmail('');
    setPassword('');
    setDisplayName('');
  }, [mode]);

  const handleSubmit = (event) => {
    event.preventDefault();
    onSubmit(mode, { email, password, displayName });
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 px-3">
      <div className="bg-gray-900 text-gray-100 rounded-2xl shadow-2xl w-full max-w-md p-6 border border-gray-700">
        <button className="text-gray-400 hover:text-gray-200 float-right" onClick={onClose} aria-label="Fermer">
          ‚úï
        </button>
        <h2 className="text-2xl font-bold mb-4">
          {mode === 'login' ? 'Connexion' : 'Cr√©er un compte'}
        </h2>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm mb-1">Email</label>
            <input
              type="email"
              required
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-indigo-500 focus:outline-none"
            />
          </div>
          <div>
            <label className="block text-sm mb-1">Mot de passe</label>
            <input
              type="password"
              required
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-indigo-500 focus:outline-none"
            />
          </div>
          {mode === 'register' && (
            <div>
              <label className="block text-sm mb-1">Pseudo affich√©</label>
              <input
                type="text"
                value={displayName}
                onChange={(e) => setDisplayName(e.target.value)}
                placeholder="Ex: Prissme"
                className="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-indigo-500 focus:outline-none"
              />
            </div>
          )}

          {error && <p className="text-sm text-red-400">{error}</p>}
          {message && <p className="text-sm text-emerald-400">{message}</p>}

          <button
            type="submit"
            disabled={loading}
            className="w-full py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-semibold transition disabled:opacity-60"
          >
            {loading ? 'Patiente...' : mode === 'login' ? 'Se connecter' : "S'inscrire"}
          </button>
        </form>
        <p className="text-sm text-gray-400 mt-4 text-center">
          {mode === 'login' ? (
            <>
              Pas encore de compte ?{' '}
              <button className="text-indigo-400 hover:text-indigo-300" onClick={() => switchMode('register')}>
                Inscris-toi
              </button>
            </>
          ) : (
            <>
              D√©j√† inscrit ?{' '}
              <button className="text-indigo-400 hover:text-indigo-300" onClick={() => switchMode('login')}>
                Connecte-toi
              </button>
            </>
          )}
        </p>
      </div>
    </div>
  );
};

const ProfileEditor = ({ formState, onChange, onSave, onClose, saving, error, hasProfile }) => {
  const updateField = (field) => (event) => {
    const value = event.target.value;
    onChange((prev) => ({ ...prev, [field]: value }));
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 px-3">
      <div className="bg-gray-900 text-gray-100 rounded-2xl shadow-2xl w-full max-w-2xl p-6 border border-gray-700">
        <button className="text-gray-400 hover:text-gray-200 float-right" onClick={onClose} aria-label="Fermer">
          ‚úï
        </button>
        <h2 className="text-2xl font-bold mb-4">
          {hasProfile ? 'Personnaliser ma carte' : 'Cr√©er ma carte joueur'}
        </h2>
        <div className="grid sm:grid-cols-2 gap-4">
          <div className="space-y-4">
            <div>
              <label className="block text-sm mb-1">Pseudo</label>
              <input
                type="text"
                value={formState.display_name}
                onChange={updateField('display_name')}
                className="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-indigo-500 focus:outline-none"
                placeholder="Ton pseudo"
              />
            </div>
            <div>
              <label className="block text-sm mb-1">Photo de profil (URL)</label>
              <input
                type="url"
                value={formState.profile_image_url}
                onChange={updateField('profile_image_url')}
                className="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-indigo-500 focus:outline-none"
                placeholder="https://..."
              />
            </div>
            <div>
              <label className="block text-sm mb-1">Discord</label>
              <input
                type="url"
                value={formState.discord}
                onChange={updateField('discord')}
                className="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-indigo-500 focus:outline-none"
                placeholder="https://discord.gg/..."
              />
            </div>
          </div>
          <div className="space-y-4">
            <div>
              <label className="block text-sm mb-1">Bio</label>
              <textarea
                rows="4"
                value={formState.bio}
                onChange={updateField('bio')}
                className="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-indigo-500 focus:outline-none"
                placeholder="Pr√©sente-toi en quelques lignes"
              />
            </div>
            <div>
              <label className="block text-sm mb-1">Scrims r√©cents</label>
              <textarea
                rows="4"
                value={formState.recent_scrims_text}
                onChange={updateField('recent_scrims_text')}
                className="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-indigo-500 focus:outline-none"
                placeholder={'Ex:\nvs Team Alpha - Victoire 3-1\nvs Squad Beta - D√©faite 1-2'}
              />
            </div>
          </div>
        </div>

        {error && <p className="text-sm text-red-400 mt-4">{error}</p>}

        <div className="mt-6 flex justify-end gap-3">
          <button
            onClick={onClose}
            className="px-4 py-2 bg-gray-800 rounded-lg hover:bg-gray-700 transition"
          >
            Annuler
          </button>
          <button
            onClick={onSave}
            disabled={saving}
            className="px-5 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-semibold transition disabled:opacity-60"
          >
            {saving ? 'Enregistrement...' : hasProfile ? 'Mettre √† jour' : 'Cr√©er ma carte'}
          </button>
        </div>
      </div>
    </div>
  );
};

const FreescapeSection = ({
  event,
  session,
  form,
  onChange,
  onSubmit,
  onCancel,
  registration,
  loading,
  submitting,
  deleting,
  error,
  success,
  onLogin,
}) => {
  const InfoCard = ({ icon, label, value }) => (
    <div className="bg-gray-900/50 border border-white/5 rounded-lg p-4">
      <div className="text-2xl mb-2">{icon}</div>
      <p className="text-xs uppercase tracking-wide text-gray-400">{label}</p>
      <p className="text-base sm:text-lg font-semibold text-gray-100">{value}</p>
    </div>
  );

  return (
    <div className="glass-effect rounded-xl p-4 sm:p-6 shadow-2xl">
      <div className="flex flex-col lg:flex-row gap-6">
        <div className="lg:w-1/2 space-y-5">
          <div>
            <p className="text-indigo-400 uppercase text-xs tracking-[0.3em]">Freescape Series</p>
            <h2 className="text-2xl sm:text-3xl font-bold text-gray-100 mt-2">{event.name}</h2>
            <p className="text-sm sm:text-base text-gray-300 mt-2 leading-relaxed">{event.description}</p>
          </div>

          <div className="grid grid-cols-2 gap-3 sm:gap-4">
            <InfoCard icon="üóìÔ∏è" label="Date" value={event.date} />
            <InfoCard icon="‚öîÔ∏è" label="Format" value={event.format} />
            <InfoCard icon="üë•" label="Places" value={event.slots} />
            <InfoCard icon="üèÜ" label="R√©compenses" value={event.prize} />
          </div>

          <div className="bg-gray-900/50 border border-white/5 rounded-lg p-4 space-y-3">
            <div className="flex items-center justify-between">
              <p className="text-sm font-semibold text-gray-200">Rotation de maps</p>
              <span className="text-xs text-gray-400">Sujet √† ajustements</span>
            </div>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
              {event.maps.map((map) => (
                <div
                  key={`${map.mode}-${map.name}`}
                  className="bg-gray-950/50 border border-indigo-500/20 rounded-lg px-3 py-2"
                >
                  <p className="text-xs text-indigo-300 uppercase tracking-wide">{map.mode}</p>
                  <p className="text-sm font-semibold text-gray-100">{map.name}</p>
                </div>
              ))}
            </div>
            <p className="text-xs text-gray-400 italic">
              Le bracket Freescape est g√©n√©r√© automatiquement √† l'heure du tournoi et se synchronise avec la page Matcherino d√©di√©e.
            </p>
          </div>

          <div className="bg-gray-900/50 border border-white/5 rounded-lg p-4 space-y-2">
            <p className="text-sm font-semibold text-gray-200">√Ä savoir</p>
            {[event.checkin, ...event.rules].map((rule, index) => (
              <p key={index} className="text-sm text-gray-300 flex gap-2">
                <span className="text-indigo-400">‚Ä¢</span>
                <span>{rule}</span>
              </p>
            ))}
          </div>

          <div className="flex flex-wrap gap-2">
            <a
              href={event.matcherinoLink}
              target="_blank"
              rel="noopener noreferrer"
              className="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 transition text-sm font-semibold"
            >
              Ouvrir la page Matcherino
            </a>
            <a
              href="https://discord.gg/prissme"
              target="_blank"
              rel="noopener noreferrer"
              className="px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition text-sm font-semibold"
            >
              Rejoindre le Discord
            </a>
          </div>
        </div>

        <div className="lg:w-1/2 bg-gray-900/50 border border-white/5 rounded-lg p-4 sm:p-5 space-y-4">
          <div>
            <h3 className="text-xl font-semibold text-gray-100">Inscription Freescape</h3>
            <p className="text-sm text-gray-400">Cr√©e ta fiche d'√©quipe pour verrouiller ta place sur le bracket automatique.</p>
          </div>

          {loading ? (
            <div className="text-sm text-gray-300">Chargement de ton inscription en cours...</div>
          ) : session ? (
            <form onSubmit={onSubmit} className="space-y-4">
              {registration && (
                <div className="bg-emerald-500/10 border border-emerald-500/30 text-emerald-300 text-sm rounded-lg p-3">
                  <p className="font-semibold">Tu es inscrit pour la Freescape Cup !</p>
                  <p className="mt-1">√âquipe : <span className="text-gray-100">{registration.team_name}</span></p>
                  {registration.share_code && (
                    <p className="mt-1 text-xs text-emerald-200">
                      Code d'invitation : <code className="font-mono text-sm">{registration.share_code}</code>
                    </p>
                  )}
                  <p className="mt-1 text-xs text-emerald-200">Modifie les informations ci-dessous pour mettre √† jour ta fiche.</p>
                </div>
              )}

              {success && (
                <div className="bg-emerald-500/10 border border-emerald-500/30 text-emerald-200 text-sm rounded-lg p-3">
                  {success}
                </div>
              )}

              {error && (
                <div className="bg-red-500/10 border border-red-500/30 text-red-200 text-sm rounded-lg p-3">
                  {error}
                </div>
              )}

              <div className="space-y-2">
                <label className="text-sm text-gray-300 font-semibold">Nom d'√©quipe</label>
                <input
                  type="text"
                  required
                  maxLength={32}
                  value={form.teamName}
                  onChange={onChange('teamName')}
                  className="w-full px-3 py-2 rounded-lg bg-gray-950/60 border border-gray-800 focus:border-indigo-500 focus:outline-none text-sm"
                  placeholder="Ex : Freescape Titans"
                />
              </div>

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div className="space-y-2">
                  <label className="text-sm text-gray-300 font-semibold">Capitaine / Brawler ID</label>
                  <input
                    type="text"
                    required
                    value={form.captain}
                    onChange={onChange('captain')}
                    className="w-full px-3 py-2 rounded-lg bg-gray-950/60 border border-gray-800 focus:border-indigo-500 focus:outline-none text-sm"
                    placeholder="Pseudo du capitaine"
                  />
                </div>
                <div className="space-y-2">
                  <label className="text-sm text-gray-300 font-semibold">Discord / Contact</label>
                  <input
                    type="text"
                    required
                    value={form.discord}
                    onChange={onChange('discord')}
                    className="w-full px-3 py-2 rounded-lg bg-gray-950/60 border border-gray-800 focus:border-indigo-500 focus:outline-none text-sm"
                    placeholder="Ex : Prissme#0001"
                  />
                </div>
              </div>

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div className="space-y-2">
                  <label className="text-sm text-gray-300 font-semibold">Titulaire #2</label>
                  <input
                    type="text"
                    required
                    value={form.playerTwo}
                    onChange={onChange('playerTwo')}
                    className="w-full px-3 py-2 rounded-lg bg-gray-950/60 border border-gray-800 focus:border-indigo-500 focus:outline-none text-sm"
                    placeholder="Pseudo du joueur"
                  />
                </div>
                <div className="space-y-2">
                  <label className="text-sm text-gray-300 font-semibold">Titulaire #3</label>
                  <input
                    type="text"
                    required
                    value={form.playerThree}
                    onChange={onChange('playerThree')}
                    className="w-full px-3 py-2 rounded-lg bg-gray-950/60 border border-gray-800 focus:border-indigo-500 focus:outline-none text-sm"
                    placeholder="Pseudo du joueur"
                  />
                </div>
              </div>

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div className="space-y-2">
                  <label className="text-sm text-gray-300 font-semibold">Rempla√ßant (optionnel)</label>
                  <input
                    type="text"
                    value={form.substitute}
                    onChange={onChange('substitute')}
                    className="w-full px-3 py-2 rounded-lg bg-gray-950/60 border border-gray-800 focus:border-indigo-500 focus:outline-none text-sm"
                    placeholder="Pseudo du rempla√ßant"
                  />
                </div>
                <div className="space-y-2">
                  <label className="text-sm text-gray-300 font-semibold">Lien Matcherino (optionnel)</label>
                  <input
                    type="url"
                    value={form.matcherino}
                    onChange={onChange('matcherino')}
                    className="w-full px-3 py-2 rounded-lg bg-gray-950/60 border border-gray-800 focus:border-indigo-500 focus:outline-none text-sm"
                    placeholder="https://matcherino.com/..."
                  />
                </div>
              </div>

              <div className="space-y-2">
                <label className="text-sm text-gray-300 font-semibold">Map pr√©f√©r√©e / Notes staff</label>
                <textarea
                  rows="3"
                  value={form.mapPreference}
                  onChange={onChange('mapPreference')}
                  className="w-full px-3 py-2 rounded-lg bg-gray-950/60 border border-gray-800 focus:border-indigo-500 focus:outline-none text-sm"
                  placeholder="Indique ta map coup de c≈ìur, un cr√©neau ou un message pour l'admin."
                ></textarea>
              </div>

              <div className="space-y-2">
                <label className="text-sm text-gray-300 font-semibold">Notes additionnelles (optionnel)</label>
                <textarea
                  rows="3"
                  value={form.notes}
                  onChange={onChange('notes')}
                  className="w-full px-3 py-2 rounded-lg bg-gray-950/60 border border-gray-800 focus:border-indigo-500 focus:outline-none text-sm"
                  placeholder="Ajoute un lien de line-up, un coach, etc."
                ></textarea>
              </div>

              <div className="flex flex-col sm:flex-row gap-3">
                <button
                  type="submit"
                  disabled={submitting}
                  className="flex-1 px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 transition text-sm font-semibold disabled:opacity-60"
                >
                  {submitting ? 'Enregistrement...' : registration ? 'Mettre √† jour mon inscription' : 'Valider mon inscription'}
                </button>
                {registration && (
                  <button
                    type="button"
                    onClick={onCancel}
                    disabled={deleting}
                    className="px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition text-sm disabled:opacity-60"
                  >
                    {deleting ? 'Annulation...' : 'Annuler mon inscription'}
                  </button>
                )}
              </div>
            </form>
          ) : (
            <div className="space-y-4 text-sm text-gray-300">
              <p>Connecte-toi ou cr√©e un compte Null's Brawl Esport pour inscrire ton √©quipe Freescape.</p>
              <button
                onClick={onLogin}
                className="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 transition text-sm font-semibold"
              >
                Se connecter / S'inscrire
              </button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

function App() {
  const [players, setPlayers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [query, setQuery] = useState('');
  const [selectedTier, setSelectedTier] = useState('ALL');
  const [sortBy, setSortBy] = useState('rank');
  const [selectedPlayer, setSelectedPlayer] = useState(null);

  const [supabaseClient, setSupabaseClient] = useState(null);
  const [authReady, setAuthReady] = useState(false);
  const [session, setSession] = useState(null);
  const [profile, setProfile] = useState(null);
  const [authModalOpen, setAuthModalOpen] = useState(false);
  const [authMode, setAuthMode] = useState('login');
  const [authProcessing, setAuthProcessing] = useState(false);
  const [authError, setAuthError] = useState('');
  const [authMessage, setAuthMessage] = useState('');

  const [profileEditorOpen, setProfileEditorOpen] = useState(false);
  const [profileForm, setProfileForm] = useState({
    display_name: '',
    profile_image_url: '',
    bio: '',
    recent_scrims_text: '',
    discord: '',
  });
  const [profileSaving, setProfileSaving] = useState(false);
  const [profileError, setProfileError] = useState('');

  const [freescapeForm, setFreescapeForm] = useState(() => ({ ...FREESCAPE_FORM_DEFAULT }));
  const [freescapeRegistration, setFreescapeRegistration] = useState(null);
  const [freescapeLoadingRegistration, setFreescapeLoadingRegistration] = useState(false);
  const [freescapeSubmitting, setFreescapeSubmitting] = useState(false);
  const [freescapeDeleting, setFreescapeDeleting] = useState(false);
  const [freescapeError, setFreescapeError] = useState('');
  const [freescapeSuccess, setFreescapeSuccess] = useState('');

  const tiers = ['ALL','S','A','B','C','D','E','No-tier'];

  const fetchPlayers = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);
      const response = await fetch(`${API_BASE}/getTop50`);
      const data = await response.json();

      if (data.ok) {
        const playersWithRank = data.top.map((p, index) => {
          const formatted = formatPlayer(p, index);
          return {
            ...formatted,
            rank: index + 1,
          };
        });
        setPlayers(playersWithRank);
      } else {
        setError(data.error || 'Erreur lors du chargement');
      }
    } catch (err) {
      setError('Impossible de charger les donn√©es. V√©rifiez votre connexion.');
      console.error('Fetch error:', err);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchPlayers();
  }, [fetchPlayers]);

  useEffect(() => {
    const initSupabase = async () => {
      if (!window.supabase) {
        setAuthReady(true);
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/getSupabaseConfig`);
        const result = await response.json();
        if (!result.ok || !result.config?.supabaseUrl || !result.config?.supabaseAnonKey) {
          setAuthError(result.error || 'Module de connexion indisponible.');
          return;
        }

        const client = window.supabase.createClient(result.config.supabaseUrl, result.config.supabaseAnonKey);
        setSupabaseClient(client);

        const { data: sessionData } = await client.auth.getSession();
        setSession(sessionData?.session || null);

        client.auth.onAuthStateChange((_event, newSession) => {
          setSession(newSession);
        });
      } catch (err) {
        console.error('Erreur Supabase:', err);
        setAuthError("Impossible d'initialiser les comptes pour le moment.");
      } finally {
        setAuthReady(true);
      }
    };

    initSupabase();
  }, []);

  useEffect(() => {
    if (!supabaseClient) return;
    if (typeof window === 'undefined') return;

    const hash = window.location.hash || '';
    if (!hash || hash.length <= 1) return;

    const params = new URLSearchParams(hash.substring(1));
    let handled = false;

    const errorDescription = params.get('error_description');
    if (errorDescription) {
      setAuthError(decodeURIComponent(errorDescription));
      setAuthModalOpen(true);
      handled = true;
    }

    const accessToken = params.get('access_token');
    const refreshToken = params.get('refresh_token');
    if (accessToken && refreshToken) {
      handled = true;
      supabaseClient.auth
        .setSession({ access_token: accessToken, refresh_token: refreshToken })
        .then(({ data: sessionData, error: sessionError }) => {
          if (sessionError) {
            setAuthError(sessionError.message || 'Impossible de finaliser la connexion.');
            setAuthModalOpen(true);
            return;
          }

          if (sessionData?.session) {
            setSession(sessionData.session);
            setAuthMessage('Inscription confirm√©e !');
            setAuthModalOpen(false);
          }
        })
        .catch((err) => {
          console.error('Session from hash error:', err);
          setAuthError(err.message || 'Impossible de finaliser la connexion.');
          setAuthModalOpen(true);
        })
        .finally(() => {
          window.location.hash = '';
        });
      return;
    }

    if (handled) {
      window.location.hash = '';
    }
  }, [supabaseClient]);

  const formatProfileFromApi = useCallback((player) => {
    const formatted = formatPlayer(player);
    if (!formatted) return null;
    return {
      ...formatted,
      recentScrims: formatted.recentScrims,
      socialLinks: formatted.socialLinks,
    };
  }, []);

  useEffect(() => {
    const loadProfile = async () => {
      if (!session?.access_token || !supabaseClient) {
        setProfile(null);
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/getPlayerProfile`, {
          headers: {
            Authorization: `Bearer ${session.access_token}`,
          },
        });
        const result = await response.json();
        if (result.ok && result.profile) {
          setProfile(formatProfileFromApi(result.profile));
        } else {
          setProfile(null);
        }
      } catch (err) {
        console.error('Erreur profil:', err);
      }
    };

    loadProfile();
  }, [session, supabaseClient, formatProfileFromApi]);

  const freescapeField = (field) => (event) => {
    const value = event.target.value;
    setFreescapeForm((prev) => ({ ...prev, [field]: value }));
    setFreescapeError('');
    setFreescapeSuccess('');
  };

  const requireAuth = useCallback(() => {
    setAuthMode('login');
    setAuthModalOpen(true);
  }, []);

  const syncFreescapeFormWithProfile = useCallback(() => {
    setFreescapeForm((prev) => ({
      ...prev,
      captain: prev.captain || profile?.name || '',
      discord: prev.discord || profile?.socialLinks?.discord || '',
    }));
  }, [profile]);

  const fetchFreescapeRegistration = useCallback(async () => {
    if (!session?.access_token) {
      setFreescapeRegistration(null);
      setFreescapeSuccess('');
      if (profile) {
        syncFreescapeFormWithProfile();
      } else {
        setFreescapeForm({ ...FREESCAPE_FORM_DEFAULT });
      }
      return;
    }

    setFreescapeLoadingRegistration(true);
    setFreescapeError('');

    try {
      const response = await fetch(`${API_BASE}/freescapeRegistration`, {
        headers: {
          Authorization: `Bearer ${session.access_token}`,
        },
      });
      const result = await response.json();
      if (result.ok) {
        const registration = result.registration
          ? {
              ...result.registration,
              players: parsePlayersList(result.registration.players),
            }
          : null;
        setFreescapeRegistration(registration);
        if (registration) {
          const players = registration.players || [];
          setFreescapeForm((prev) => ({
            ...prev,
            teamName: registration.team_name || '',
            captain: registration.captain_name || players[0] || profile?.name || '',
            playerTwo: players[1] || '',
            playerThree: players[2] || '',
            substitute: registration.substitute || '',
            matcherino: registration.matcherino_link || '',
            notes: registration.notes || '',
            mapPreference: registration.map_preference || '',
            discord: registration.contact || prev.discord || profile?.socialLinks?.discord || '',
          }));
        } else {
          syncFreescapeFormWithProfile();
        }
      } else {
        setFreescapeError(result.error || 'Impossible de charger ton inscription Freescape.');
      }
    } catch (err) {
      console.error('Freescape fetch error:', err);
      setFreescapeError(err.message || 'Impossible de charger ton inscription Freescape.');
    } finally {
      setFreescapeLoadingRegistration(false);
    }
  }, [session, profile, syncFreescapeFormWithProfile]);

  useEffect(() => {
    fetchFreescapeRegistration();
  }, [fetchFreescapeRegistration]);

  useEffect(() => {
    if (profile && session?.access_token && !freescapeRegistration) {
      syncFreescapeFormWithProfile();
    }
  }, [profile, session, freescapeRegistration, syncFreescapeFormWithProfile]);

  const filteredPlayers = useMemo(() => {
    let list = [...players];
    if (selectedTier !== 'ALL') list = list.filter(p => p.tier === selectedTier);
    if (query.trim() !== '') list = list.filter(p => p.name.toLowerCase().includes(query.toLowerCase()));
    list.sort((a,b) => {
      if(sortBy === 'rank') return a.rank - b.rank;
      if(sortBy === 'score') return b.score - a.score;
      return a.name.localeCompare(b.name);
    });
    return list;
  }, [players, query, selectedTier, sortBy]);

  const handleAuthSubmit = async (mode, form) => {
    if (!supabaseClient) return;
    setAuthProcessing(true);
    setAuthError('');
    setAuthMessage('');

    try {
      if (mode === 'login') {
        const { error: signInError } = await supabaseClient.auth.signInWithPassword({
          email: form.email,
          password: form.password,
        });
        if (signInError) throw signInError;
        setAuthModalOpen(false);
        setAuthMessage('Connexion r√©ussie.');
      } else {
        const emailRedirectTo = `${window.location.origin}/`;
        const { data, error: signUpError } = await supabaseClient.auth.signUp({
          email: form.email,
          password: form.password,
          options: {
            emailRedirectTo,
            data: {
              display_name: form.displayName || null,
            },
          },
        });
        if (signUpError) throw signUpError;

        if (data?.session?.access_token) {
          await syncProfile(data.session.access_token, form.displayName || undefined);
          setAuthModalOpen(false);
        } else {
          setAuthMessage('Compte cr√©√© ! V√©rifie tes emails pour confirmer ton inscription.');
        }
      }
    } catch (err) {
      console.error('Auth error:', err);
      setAuthError(err.message || 'Une erreur est survenue.');
    } finally {
      setAuthProcessing(false);
    }
  };

  const syncProfile = async (accessToken, displayName) => {
    try {
      const response = await fetch(`${API_BASE}/registerUser`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${accessToken}`,
        },
        body: JSON.stringify({
          display_name: displayName,
        }),
      });
      const result = await response.json();
      if (result.ok && result.player) {
        setProfile(formatProfileFromApi(result.player));
        fetchPlayers();
        fetchFreescapeRegistration();
      }
    } catch (err) {
      console.error('Sync profile error:', err);
    }
  };

  const openProfileEditor = () => {
    if (!session?.access_token) {
      setAuthMode('login');
      setAuthModalOpen(true);
      return;
    }

    setProfileForm({
      display_name: profile?.name || '',
      profile_image_url: profile?.profileImage || '',
      bio: profile?.bio || '',
      recent_scrims_text: (profile?.recentScrims || []).join('\n'),
      discord: profile?.socialLinks?.discord || '',
    });
    setProfileError('');
    setProfileEditorOpen(true);
  };

  const handleProfileSave = async () => {
    if (!session?.access_token) return;
    setProfileSaving(true);
    setProfileError('');

    const recentScrims = profileForm.recent_scrims_text
      .split('\n')
      .map(line => line.trim())
      .filter(Boolean);

    const socialLinks = {};
    if (profileForm.discord) socialLinks.discord = profileForm.discord;

    const payload = {
      display_name: profileForm.display_name,
      profile_image_url: profileForm.profile_image_url,
      bio: profileForm.bio,
      recent_scrims: recentScrims,
      social_links: Object.keys(socialLinks).length > 0 ? socialLinks : null,
    };

    const endpoint = profile ? 'updatePlayerProfile' : 'registerUser';

    try {
      const response = await fetch(`${API_BASE}/${endpoint}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${session.access_token}`,
        },
        body: JSON.stringify(payload),
      });
      const result = await response.json();
      if (result.ok) {
        const updated = result.profile || result.player;
        setProfile(formatProfileFromApi(updated));
        setProfileEditorOpen(false);
        fetchPlayers();
        fetchFreescapeRegistration();
      } else {
        setProfileError(result.error || 'Impossible de sauvegarder le profil.');
      }
    } catch (err) {
      console.error('Profile save error:', err);
      setProfileError(err.message || 'Impossible de sauvegarder le profil.');
    } finally {
      setProfileSaving(false);
    }
  };

  const handleFreescapeSubmit = async (event) => {
    event.preventDefault();

    if (!session?.access_token) {
      requireAuth();
      return;
    }

    setFreescapeError('');
    setFreescapeSuccess('');

    const teamName = freescapeForm.teamName.trim();
    const captain = freescapeForm.captain.trim();
    const playerTwo = freescapeForm.playerTwo.trim();
    const playerThree = freescapeForm.playerThree.trim();
    const contact = freescapeForm.discord.trim();
    const substitute = freescapeForm.substitute.trim();
    const matcherino = freescapeForm.matcherino.trim();
    const notes = freescapeForm.notes.trim();
    const mapPreference = freescapeForm.mapPreference.trim();

    if (teamName.length < 3) {
      setFreescapeError("Choisis un nom d'√©quipe d'au moins 3 caract√®res.");
      return;
    }

    const players = [captain, playerTwo, playerThree]
      .map((name) => name.replace(/\s+/g, ' ').trim())
      .filter(Boolean);

    if (players.length < 3) {
      setFreescapeError('Indique les pseudos des trois titulaires.');
      return;
    }

    const uniquePlayers = new Set(players.map((name) => name.toLowerCase()));
    if (uniquePlayers.size !== players.length) {
      setFreescapeError('Chaque titulaire doit avoir un pseudo unique.');
      return;
    }

    if (!contact || contact.length < 3) {
      setFreescapeError('Ajoute un contact Discord ou une m√©thode de contact valide.');
      return;
    }

    const payload = {
      team_name: teamName,
      captain_name: players[0],
      players,
      contact,
      substitute: substitute || null,
      matcherino_link: matcherino || null,
      notes: notes || null,
      map_preference: mapPreference || null,
    };

    setFreescapeSubmitting(true);

    try {
      const response = await fetch(`${API_BASE}/freescapeRegistration`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${session.access_token}`,
        },
        body: JSON.stringify(payload),
      });
      const result = await response.json();
      if (result.ok) {
        const registration = result.registration
          ? {
              ...result.registration,
              players: parsePlayersList(result.registration.players),
            }
          : null;
        setFreescapeRegistration(registration);
        if (registration) {
          const playersFromServer = registration.players || players;
          setFreescapeForm((prev) => ({
            ...prev,
            teamName: registration.team_name || teamName,
            captain: registration.captain_name || playersFromServer[0] || captain,
            playerTwo: playersFromServer[1] || playerTwo,
            playerThree: playersFromServer[2] || playerThree,
            substitute: registration.substitute || substitute,
            matcherino: registration.matcherino_link || matcherino,
            notes: registration.notes || notes,
            mapPreference: registration.map_preference || mapPreference,
            discord: registration.contact || contact,
          }));
        }
        setFreescapeSuccess('Ton inscription Freescape est enregistr√©e !');
      } else {
        setFreescapeError(result.error || "Impossible d'enregistrer ton inscription Freescape.");
      }
    } catch (err) {
      console.error('Freescape submit error:', err);
      setFreescapeError(err.message || "Impossible d'enregistrer ton inscription Freescape.");
    } finally {
      setFreescapeSubmitting(false);
    }
  };

  const handleFreescapeCancel = async () => {
    if (!session?.access_token) {
      requireAuth();
      return;
    }

    setFreescapeError('');
    setFreescapeSuccess('');
    setFreescapeDeleting(true);

    try {
      const response = await fetch(`${API_BASE}/freescapeRegistration`, {
        method: 'DELETE',
        headers: {
          Authorization: `Bearer ${session.access_token}`,
        },
      });
      const result = await response.json();
      if (result.ok) {
        setFreescapeRegistration(null);
        setFreescapeForm({
          ...FREESCAPE_FORM_DEFAULT,
          captain: profile?.name || '',
          discord: profile?.socialLinks?.discord || '',
        });
        setFreescapeSuccess('Ton inscription Freescape a √©t√© annul√©e.');
      } else {
        setFreescapeError(result.error || "Impossible d'annuler ton inscription.");
      }
    } catch (err) {
      console.error('Freescape cancel error:', err);
      setFreescapeError(err.message || "Impossible d'annuler ton inscription.");
    } finally {
      setFreescapeDeleting(false);
    }
  };

  const handleSignOut = async () => {
    if (!supabaseClient) return;
    await supabaseClient.auth.signOut();
    setProfile(null);
    setSelectedPlayer(null);
    setFreescapeRegistration(null);
    setFreescapeForm({ ...FREESCAPE_FORM_DEFAULT });
    setFreescapeSuccess('');
    setFreescapeError('');
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-b from-gray-900 via-gray-800 to-black text-gray-100 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-indigo-500 mx-auto mb-4"></div>
          <p className="text-xl">Chargement du classement...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen bg-gradient-to-b from-gray-900 via-gray-800 to-black text-gray-100 flex items-center justify-center p-6">
        <div className="glass-effect rounded-xl p-8 max-w-md text-center">
          <p className="text-red-400 text-xl mb-4">‚ùå {error}</p>
          <button onClick={fetchPlayers} className="px-6 py-3 bg-indigo-600 rounded-lg hover:bg-indigo-500 transition font-semibold">
            R√©essayer
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-gray-900 via-gray-800 to-black text-gray-100 p-3 sm:p-6">
      <header className="max-w-5xl mx-auto mb-6 sm:mb-8 space-y-4">
        <div className="text-center">
          <h1 className="text-3xl sm:text-5xl font-extrabold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500">
            Nulls Brawl Esport
          </h1>
          <p className="text-gray-400 text-base sm:text-lg">Top 50 Classement Officiel</p>
          <button onClick={fetchPlayers} className="mt-2 text-sm text-indigo-400 hover:text-indigo-300 underline">
            üîÑ Actualiser
          </button>
        </div>

        <div className="glass-effect rounded-xl p-3 sm:p-4 space-y-4">
          <div className="flex gap-2 flex-wrap justify-center">
            <a href="https://discord.gg/prissme" target="_blank" rel="noopener noreferrer" className="px-3 sm:px-4 py-2 bg-indigo-600 rounded-lg hover:bg-indigo-500 transition font-semibold shadow-lg text-sm sm:text-base">
              Discord
            </a>
            <a href="https://ko-fi.com/prissme" target="_blank" rel="noopener noreferrer" className="px-3 sm:px-4 py-2 bg-yellow-500 rounded-lg hover:bg-yellow-400 transition font-semibold shadow-lg text-black text-sm sm:text-base">
              Coaching 9‚Ç¨
            </a>
          </div>

          <div className="flex flex-col sm:flex-row gap-2 sm:gap-3">
            <input
              placeholder="Rechercher un joueur..."
              value={query}
              onChange={e => setQuery(e.target.value)}
              className="flex-1 px-3 sm:px-4 py-2 rounded-lg bg-gray-800/50 text-gray-100 border border-gray-700 focus:border-indigo-500 focus:outline-none text-sm sm:text-base"
            />
            <select
              value={sortBy}
              onChange={e => setSortBy(e.target.value)}
              className="px-3 sm:px-4 py-2 rounded-lg bg-gray-800/50 border border-gray-700 focus:border-indigo-500 text-sm sm:text-base"
            >
              <option value="rank">Par Rang</option>
              <option value="score">Par Score</option>
              <option value="name">Par Pseudo</option>
            </select>
          </div>

          <div className="flex gap-2 flex-wrap justify-center">
            {tiers.map(t => (
              <button
                key={t}
                onClick={() => setSelectedTier(t)}
                className={`px-3 sm:px-4 py-1.5 sm:py-2 rounded-full text-xs sm:text-sm font-bold transition-all duration-300 ${
                  selectedTier === t
                    ? 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg scale-105'
                    : 'bg-gray-800/50 text-gray-300 hover:bg-gray-700'
                }`}
              >
                {t}
              </button>
            ))}
          </div>
        </div>

        <div className="glass-effect rounded-xl p-4 sm:p-5">
          {!authReady ? (
            <p className="text-sm text-gray-400">Chargement du module de comptes...</p>
          ) : session ? (
            <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
              <div>
                <p className="text-sm text-gray-400">Connect√© en tant que</p>
                <p className="font-semibold">{session.user?.email}</p>
                {profile?.name && <p className="text-xs text-gray-400">Carte: {profile.name}</p>}
              </div>
              <div className="flex gap-2 flex-wrap">
                <button
                  onClick={openProfileEditor}
                  className="px-4 py-2 bg-indigo-600 rounded-lg hover:bg-indigo-500 transition text-sm font-semibold"
                >
                  {profile ? 'Modifier ma carte' : 'Cr√©er ma carte'}
                </button>
                <button
                  onClick={handleSignOut}
                  className="px-4 py-2 bg-gray-800 rounded-lg hover:bg-gray-700 transition text-sm"
                >
                  Se d√©connecter
                </button>
              </div>
            </div>
          ) : (
            <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
              <div>
                <p className="text-sm text-gray-400">
                  Connecte-toi pour personnaliser ta carte, ajouter ta photo de profil et afficher tes derniers scrims.
                </p>
                {authError && <p className="text-xs text-red-400 mt-1">{authError}</p>}
              </div>
              <button
                onClick={() => {
                  setAuthMode('login');
                  setAuthError('');
                  setAuthModalOpen(true);
                }}
                className="px-4 py-2 bg-indigo-600 rounded-lg hover:bg-indigo-500 transition text-sm font-semibold"
              >
                Se connecter / S'inscrire
              </button>
            </div>
          )}
        </div>
      </header>

      <section className="max-w-5xl mx-auto mb-6 sm:mb-8">
        <FreescapeSection
          event={FREESCAPE_EVENT}
          session={session}
          form={freescapeForm}
          onChange={freescapeField}
          onSubmit={handleFreescapeSubmit}
          onCancel={handleFreescapeCancel}
          registration={freescapeRegistration}
          loading={freescapeLoadingRegistration}
          submitting={freescapeSubmitting}
          deleting={freescapeDeleting}
          error={freescapeError}
          success={freescapeSuccess}
          onLogin={requireAuth}
        />
      </section>

      <section className="max-w-5xl mx-auto mb-6 sm:mb-8">
        <div className="glass-effect rounded-xl p-4 sm:p-6 shadow-2xl">
          <h2 className="text-2xl sm:text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-purple-400 mb-4">
            üìä Statistiques
          </h2>
          <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4">
            <div className="bg-gray-800/50 p-3 sm:p-4 rounded-lg text-center">
              <p className="text-gray-400 text-sm">Joueurs actifs</p>
              <p className="text-2xl sm:text-3xl font-bold text-indigo-400">{players.length}</p>
            </div>
            <div className="bg-gray-800/50 p-3 sm:p-4 rounded-lg text-center">
              <p className="text-gray-400 text-sm">MMR moyen</p>
              <p className="text-2xl sm:text-3xl font-bold text-purple-400">
                {players.length > 0 ? Math.round(players.reduce((acc, p) => acc + p.score, 0) / players.length) : 0}
              </p>
            </div>
            <div className="bg-gray-800/50 p-3 sm:p-4 rounded-lg text-center">
              <p className="text-gray-400 text-sm">Top MMR</p>
              <p className="text-2xl sm:text-3xl font-bold text-yellow-400">
                {players.length > 0 ? Math.max(...players.map(p => p.score)) : 0}
              </p>
            </div>
            <div className="bg-gray-800/50 p-3 sm:p-4 rounded-lg text-center">
              <p className="text-gray-400 text-sm">Parties jou√©es</p>
              <p className="text-2xl sm:text-3xl font-bold text-green-400">
                {players.reduce((acc, p) => acc + (p.gamesPlayed || 0), 0)}
              </p>
            </div>
          </div>
        </div>
      </section>

      <main className="max-w-5xl mx-auto">
        {filteredPlayers.length === 0 ? (
          <div className="glass-effect rounded-xl p-8 text-center">
            <p className="text-xl text-gray-400">Aucun joueur trouv√© üîç</p>
          </div>
        ) : (
          <div className="grid gap-3 sm:gap-4">
            {filteredPlayers.map(player => (
              <PlayerCard key={player.id} player={player} onSelect={setSelectedPlayer} />
            ))}
          </div>
        )}
      </main>

      <footer className="max-w-5xl mx-auto mt-8 sm:mt-12 text-center text-gray-400 text-xs sm:text-sm px-3">
        <p>¬© 2025 Null's Brawl Esport ‚Äì D√©velopp√© par <span className="text-indigo-400 font-bold">Prissme</span></p>
        <p className="mt-2 text-xs opacity-50">Donn√©es charg√©es en temps r√©el depuis Supabase</p>
      </footer>

      {selectedPlayer && (
        <PlayerModal
          player={selectedPlayer}
          onClose={() => setSelectedPlayer(null)}
          onEdit={() => {
            setSelectedPlayer(null);
            openProfileEditor();
          }}
          isOwner={profile?.id === selectedPlayer.id}
        />
      )}

      {authModalOpen && (
        <AuthModal
          mode={authMode}
          onClose={() => setAuthModalOpen(false)}
          onSubmit={handleAuthSubmit}
          switchMode={(mode) => {
            setAuthMode(mode);
            setAuthError('');
            setAuthMessage('');
          }}
          loading={authProcessing}
          error={authError}
          message={authMessage}
        />
      )}

      {profileEditorOpen && (
        <ProfileEditor
          formState={profileForm}
          onChange={setProfileForm}
          onSave={handleProfileSave}
          onClose={() => setProfileEditorOpen(false)}
          saving={profileSaving}
          error={profileError}
          hasProfile={Boolean(profile)}
        />
      )}
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);

</script>
</body>
</html>
